jQuery(document).ready(function(jQuery){var self=null;jQuery.fn.autogrow=function(o)
{return this.each(function(){new jQuery.autogrow(this,o);});};jQuery.autogrow=function(e,o)
{this.options=o||{};this.dummy=null;this.interval=null;this.line_height=this.options.lineHeight||parseInt(jQuery(e).css('line-height'));this.min_height=this.options.minHeight||parseInt(jQuery(e).css('min-height'));this.max_height=this.options.maxHeight||parseInt(jQuery(e).css('max-height'));;this.textarea=jQuery(e);if(this.line_height==NaN)
this.line_height=0;this.init();};jQuery.autogrow.fn=jQuery.autogrow.prototype={autogrow:'1.2.2'};jQuery.autogrow.fn.extend=jQuery.autogrow.extend=jQuery.extend;jQuery.autogrow.fn.extend({init:function(){var self=this;this.textarea.css({overflow:'hidden',display:'block'});this.textarea.bind('focus',function(){self.startExpand()}).bind('blur',function(){self.stopExpand()});this.checkExpand();},startExpand:function(){var self=this;this.interval=window.setInterval(function(){self.checkExpand()},400);},stopExpand:function(){clearInterval(this.interval);},checkExpand:function(){var current_chars=this.textarea.val().length;if(this.last_chars==undefined)this.last_chars=current_chars;if(this.char_diff==undefined)this.cumulative_char_diff=0;var iteration_char_difference=current_chars-this.last_chars;this.last_chars=current_chars;this.cumulative_char_diff+=iteration_char_difference;var absolute_char_diff=Math.abs(this.char_diff);var height_difference=Math.abs(this.textarea.attr('scrollHeight')-this.textarea.attr('clientHeight'));if(!height_difference&&absolute_char_diff<10)return;if(this.dummy==null)
{this.dummy=jQuery('<div></div>');this.dummy.css({'font-size':this.textarea.css('font-size'),'font-family':this.textarea.css('font-family'),'width':this.textarea.css('width'),'padding-left':this.textarea.css('padding-left'),'padding-right':this.textarea.css('padding-right'),'padding-top':this.textarea.css('padding-top'),'padding-bottom':this.textarea.css('padding-bottom'),'line-height':this.line_height+'px','overflow-x':'hidden','position':'absolute','top':0,'left':-9999}).appendTo('body');}
var html=this.textarea.val().replace(/(<|>)/g,'');if(jQuery.browser.msie)
{html=html.replace(/\n/g,'<BR>new');}
else
{html=html.replace(/\n/g,'<br>new');}
if(this.dummy.html()!=html)
{this.dummy.html(html);if(this.max_height>0&&(this.dummy.height()+this.line_height>this.max_height))
{this.textarea.css('overflow-y','auto');}
else
{this.textarea.css('overflow-y','hidden');if(this.textarea.height()<this.dummy.height()+this.line_height||(this.dummy.height()<this.textarea.height()))
{this.textarea.css({height:(this.dummy.height()+this.line_height)+'px'});}}}
this.cumulative_char_diff=0;}});});;jQuery(document).ready(function($){if($.autogrow)
$('textarea.TextBox').livequery(function(){$(this).autogrow();});$('#CommentForm :submit').click(function(){var btn=this;var frm=$(btn).parents('form').get(0);$(frm).triggerHandler('BeforeCommentSubmit',[frm,btn]);var textbox=$(frm).find('textarea');var inpCommentID=$(frm).find('input:hidden[name$=CommentID]');var inpDraftID=$(frm).find('input:hidden[name$=DraftID]');var preview=$(btn).attr('name')==$('#Form_Preview').attr('name')?true:false;var draft=$(btn).attr('name')==$('#Form_SaveDraft').attr('name')?true:false;var postValues=$(frm).serialize();postValues+='&DeliveryType=VIEW&DeliveryMethod=JSON';postValues+='&'+btn.name+'='+btn.value;var discussionID=$(frm).find('[name$=DiscussionID]').val();var action=$(frm).attr('action')+'/'+discussionID;$(frm).find(':submit:last').after('<span class="Progress">&#160;</span>');$(frm).find(':submit').attr('disabled','disabled');$.ajax({type:"POST",url:action,data:postValues,dataType:'json',error:function(XMLHttpRequest,textStatus,errorThrown){$('div.Popup').remove();$.popup({},XMLHttpRequest.responseText);},success:function(json){json=$.postParseJson(json);if(!draft)
$('div.Popup').remove();if(json.CommentID!=null&&json.CommentID!=''){$(inpCommentID).val(json.CommentID);gdn.definition('LastCommentID',json.CommentID,true);}
if(json.DraftID!=null&&json.DraftID!='')
$(inpDraftID).val(json.DraftID);$(frm).find('div.Errors').remove();if(json.FormSaved==false){$(frm).prepend(json.ErrorMessages);json.ErrorMessages=null;}else if(preview){$.popup({},json.Data);}else if(!draft&&json.DiscussionUrl!=null){$(frm).triggerHandler('complete');document.location=json.DiscussionUrl;}
gdn.inform(json);},complete:function(XMLHttpRequest,textStatus){$('span.Progress').remove();$(frm).find(':submit').removeAttr("disabled");}});$(frm).triggerHandler('submit');return false;});$('#DiscussionForm :submit').click(function(){var btn=this;var frm=$(btn).parents('form').get(0);$(frm).triggerHandler('BeforeDiscussionSubmit',[frm,btn]);var textbox=$(frm).find('textarea');var inpDiscussionID=$(frm).find(':hidden[name$=DiscussionID]');var inpDraftID=$(frm).find(':hidden[name$=DraftID]');var preview=$(btn).attr('name')==$('#Form_Preview').attr('name')?true:false;var draft=$(btn).attr('name')==$('#Form_SaveDraft').attr('name')?true:false;var postValues=$(frm).serialize();postValues+='&DeliveryType=VIEW&DeliveryMethod=JSON';postValues+='&'+btn.name+'='+btn.value;$(frm).find(':submit:last').after('<span class="Progress">&#160;</span>');$(frm).find(':submit').attr('disabled','disabled');$.ajax({type:"POST",url:$(frm).attr('action'),data:postValues,dataType:'json',error:function(XMLHttpRequest,textStatus,errorThrown){$('div.Popup').remove();$.popup({},XMLHttpRequest.responseText);},success:function(json){json=$.postParseJson(json);if(!draft)
$('div.Popup').remove();if(json.DiscussionID!=null)
$(inpDiscussionID).val(json.DiscussionID);if(json.DraftID!=null)
$(inpDraftID).val(json.DraftID);$(frm).find('div.Errors').remove();if(json.FormSaved==false){$(frm).prepend(json.ErrorMessages);json.ErrorMessages=null;}else if(preview){$.popup({},json.Data);}else if(!draft){if(json.RedirectUrl){$(frm).triggerHandler('complete');document.location=json.RedirectUrl;}else{$('#Content').html(json.Data);}}
gdn.inform(json);},complete:function(XMLHttpRequest,textStatus){$('span.Progress').remove();$(frm).find(':submit').removeAttr("disabled");}});$(frm).triggerHandler('submit');return false;});$('#Form_SaveDraft').livequery(function(){var btn=this;$('#CommentForm textarea').autosave({button:btn});$('#DiscussionForm textarea').autosave({button:btn});});});;jQuery(document).ready(function($){$.fn.autosave=function(opts){var options=$.extend({interval:60000,button:false},opts);var textarea=this;if(!options.button)
return false;var lastVal=null;var save=function(){var currentVal=$(textarea).val();if(currentVal!=undefined&&currentVal!=''&&currentVal!=lastVal){lastVal=currentVal
$(options.button).click();}
setTimeout(save,options.interval);};setTimeout(save,options.interval);return this;}});;function Gdn_Uploaders(){this.Uploaders=[];this.UploaderID=0;this.MaxUploadSize=1;this.UploaderIndex=0;this.MaxUploadSize=gdn.definition('maxuploadsize');Gdn_Uploaders.prototype.Prepare=function(){this.isOpera=false;this.isIE=false;this.ieVersion=0;this.CompatibilityMode=false;if(typeof(window.opera)!='undefined')
this.isOpera=true;if(!this.isOpera&&(navigator.userAgent.indexOf('Internet Explorer')>=0||navigator.userAgent.indexOf('MSIE'))>=0)
this.isIE=true;if(this.isIE){this.ieVersion=this.InternetExplorerVersion();if(this.ieVersion>=7&&this.ieVersion<=8)
this.CompatibilityMode=true;}
var Our=this;jQuery('div.AttachmentWindow').each(function(i,AttachmentWindow){Our.Spawn(jQuery(AttachmentWindow));});}
Gdn_Uploaders.prototype.Spawn=function(AttachmentWindow){if(AttachmentWindow.attr('spawned'))return;AttachmentWindow.attr('spawned',true);this.Uploaders[this.UploaderIndex]=new Gdn_MultiFileUpload(AttachmentWindow,'UploadAttachment',this);this.Uploaders[this.UploaderIndex].isOpera=this.isOpera;this.Uploaders[this.UploaderIndex].isIE=this.isIE;this.Uploaders[this.UploaderIndex].ieVersion=this.ieVersion;this.Uploaders[this.UploaderIndex].CompatibilityMode=this.CompatibilityMode;this.Uploaders[this.UploaderIndex].Apc((gdn.definition('apcavailable'))?'true':'false');this.Uploaders[this.UploaderIndex].Ready();this.UploaderIndex++;}
Gdn_Uploaders.prototype.GetFreshID=function(){return++this.UploaderID;}
Gdn_Uploaders.prototype.GetUniqID=function(){var NewDate=new Date();return NewDate.getTime();}
Gdn_Uploaders.prototype.InternetExplorerVersion=function(){var rv=-1;if(navigator.appName=='Microsoft Internet Explorer'){var ua=navigator.userAgent;var re=new RegExp("MSIE ([0-9]{1,}[\.0-9]{0,})");if(re.exec(ua)!=null)
rv=parseFloat(RegExp.$1);}
return rv;}}
function Gdn_MultiFileUpload(AttachmentWindow,AttachFileRootName,Uploaders){this.Master=Uploaders;this.AttachmentWindow=jQuery(AttachmentWindow);this.AttachmentWindowHTML=this.AttachmentWindow.html();this.AttachFileRootName=AttachFileRootName;this.UploaderContainer=null;this.IFrameContainer=null;this.IFrames={};this.TID=0;this.APC=false;Gdn_MultiFileUpload.prototype.Apc=function(ApcStatus){this.APC=ApcStatus;}
Gdn_MultiFileUpload.prototype.Ready=function(){this.MaxUploadSize=this.Master.MaxUploadSize;this.UniqID=this.Master.GetUniqID();var UploaderContainer=document.createElement('div');var UploaderContainerID='ctnr'+Math.floor(Math.random()*99999);UploaderContainer.id=UploaderContainerID;jQuery(document.body).append(UploaderContainer);this.UploaderContainer=jQuery('#'+UploaderContainerID);var IFrameContainer=document.createElement('div');var IFrameContainerID='frmz'+Math.floor(Math.random()*99999);IFrameContainer.id=IFrameContainerID;jQuery(document.body).append(IFrameContainer);this.IFrameContainer=jQuery('#'+IFrameContainerID);this.IFrameContainer.hide();jQuery('div.Attachments a.DeleteFile').popup({confirm:true,followConfirm:false,deliveryType:'JSON',afterConfirm:function(json,sender){var MediaData=json.Delete;var FileRow=jQuery(sender).closest('.Attachment');if(MediaData.Status=='success'){FileRow.remove();}}});this.Reset();jQuery('#'+this.CurrentInput).css('opacity',0);}
Gdn_MultiFileUpload.prototype.Reset=function(){this.AttachmentWindow.html(this.AttachmentWindowHTML);this.AttachFileLink=this.AttachmentWindow.find('div.AttachFileLink a').first();this.FileContainer=this.AttachmentWindow.find('div.AttachFileContainer').first();this.CurrentUploader=this.AttachmentWindow.find('div.AttachFileLink div.CurrentUploader').first();if(this.CurrentInput){this.ShowUploader(true);this.RemoveUploader(this.CurrentInput);}
this.MyFiles=[];this.ProgressBars={};this.CurrentInput=null;var UploaderID=this.NewUploader();var Click=jQuery.proxy(this.ShowUploader,this);this.AttachFileLink.click(function(){Click();return false;});this.AttachFileLink.parents('form').bind('complete',jQuery.proxy(this.Reset,this));}
Gdn_MultiFileUpload.prototype.CreateElement=function(ElementType,SetOptions){if(this.CompatibilityMode){var ElementString='<'+ElementType+' ';if(SetOptions.name!=undefined)ElementString+='name="'+SetOptions.name+'"';if(SetOptions.id!=undefined)ElementString+='id="'+SetOptions.id+'"';ElementString+='>';var Element=document.createElement(ElementString);}else{var Element=document.createElement(ElementType);}
for(var prop in SetOptions){var propval=SetOptions[prop];Element.setAttribute(prop,propval);}
if(ElementType=='form'&&this.CompatibilityMode){if(SetOptions.enctype){encType=Element.getAttributeNode("enctype");encType.value=SetOptions.enctype;}
if(SetOptions.method){formMethod=Element.getAttributeNode("method");formMethod.value=SetOptions.method;}}
return Element;}
Gdn_MultiFileUpload.prototype.NewUploader=function(){var NewUploaderID=null;var AutoShow=true;if(this.CurrentInput==null)
AutoShow=false;NewUploaderID=this.Master.GetFreshID();NewUploaderID=[this.AttachFileRootName,NewUploaderID].join('_');var Action=['post','upload',NewUploaderID];var IFrameName=this.NewFrame(NewUploaderID);var FormName=IFrameName+'_form';var UploaderForm=this.CreateElement('form',{'name':FormName,'id':FormName,'target':IFrameName,'enctype':'multipart/form-data','className':'FileUpload','method':'POST','action':gdn.url(Action.join('/'))});if(this.APC){var APCNotifier=this.CreateElement('input',{'type':'hidden','name':'APC_UPLOAD_PROGRESS','id':NewUploaderID+'_apckey','value':this.UniqID+'_'+NewUploaderID});jQuery(UploaderForm).append(APCNotifier);}
var NewUploader=this.CreateElement('input',{'type':'file','name':NewUploaderID,'id':NewUploaderID,'rel':FormName});jQuery(UploaderForm).append(NewUploader);var MaxUploadSize=this.CreateElement('input',{'type':'hidden','name':'MAX_UPLOAD_SIZE','value':this.MaxUploadSize});jQuery(UploaderForm).append(MaxUploadSize);this.CurrentUploader.append(UploaderForm);this.CurrentInput=NewUploaderID;this.ProgressBars[NewUploaderID]={'Target':IFrameName,'Filename':'','TimerID':0,'ApcKey':this.UniqID+'_'+NewUploaderID,'Progress':0,'Size':0,'Complete':false};if(AutoShow)
this.ShowUploader(true);jQuery('#'+this.CurrentInput).change(jQuery.proxy(this.DispatchCurrentUploader,this));return NewUploaderID;}
Gdn_MultiFileUpload.prototype.ShowUploader=function(NoAnimate){var UploaderElement=this.CurrentUploader;if(typeof(NoAnimate)=='object'){UploaderElement.animate({'height':'24px'},300,jQuery.proxy(function(){UploaderElement.find('form input[type=file]').css('display','block');UploaderElement.find('form input[type=file]').animate({'opacity':1});},this));}else{UploaderElement.animate({'height':'24px'},0,function(){UploaderElement.find('form input[type=file]').css('display','block');UploaderElement.find('form input[type=file]').css('opacity',1);});}}
Gdn_MultiFileUpload.prototype.NewFrame=function(TargetUploaderID){var IFrameName='frm'+Math.floor(Math.random()*99999);var ContainerDiv=document.createElement('div');var IFrame=this.CreateElement('iframe',{'name':IFrameName,'id':IFrameName,'src':'about:blank'});jQuery(IFrame).css('display','none');jQuery(ContainerDiv).append(IFrame);jQuery(this.IFrameContainer).append(ContainerDiv);this.IFrames[IFrameName]={ready:'no'};jQuery('#'+IFrameName).load(jQuery.proxy(function(){this.UploadComplete(IFrameName,TargetUploaderID);},this));return IFrameName;}
Gdn_MultiFileUpload.prototype.DispatchCurrentUploader=function(ChangeEvent){this.UploaderContainer.append(jQuery('form#'+jQuery('#'+this.CurrentInput).attr('rel')));var Target=jQuery(ChangeEvent.target);jQuery('#'+Target.attr('rel')).append(Target);var UploaderID=Target.attr('id');this.RememberFile(Target);var IFrameName=Target.parent().attr('target');this.IFrames[IFrameName].ready='yes';Target.parent().submit();this.NewUploader();}
Gdn_MultiFileUpload.prototype.RememberFile=function(FileInput){var FileName=FileInput.val();FileName=FileName.split('/').pop();FileName=FileName.split('\\').pop();var UploaderID=FileInput.attr('id');this.ProgressBars[UploaderID].Filename=FileName
FileInput.attr('style','');FileInput.hide();var PrototypeFileAttachment=jQuery(this.FileContainer.find('div.PrototypicalAttachment')[0]).clone();var FileNameDiv=jQuery(PrototypeFileAttachment).find('.FileName');var FileSizeDiv=jQuery(PrototypeFileAttachment).find('.FileSize');var ProgressDiv=jQuery(PrototypeFileAttachment).find('.UploadProgress');jQuery(FileNameDiv).html(FileName);jQuery(FileSizeDiv).html('');jQuery(jQuery(ProgressDiv).find('div.Background')).css('width','0px');var FileListingID=[FileInput.attr('id'),'listing'].join('_');PrototypeFileAttachment.attr('id',FileListingID);PrototypeFileAttachment.css('display','inline-block');PrototypeFileAttachment.appendTo(this.FileContainer);this.Progress(FileInput.attr('id'));return UploaderID;}
Gdn_MultiFileUpload.prototype.Progress=function(Data,ResponseStatus,XMLResponse){if(!this.APC)return;var ExecuteApcLookup=this.APC;if(this.ProgressBars[Data]){var ApcKey=this.ProgressBars[Data].ApcKey;var Progress=this.ProgressBars[Data].Progress;var UploaderID=Data;}else{if(!Data)return;var JData=jQuery.parseJSON(Data);if(JData&&JData.Progress){var JProgress=JData.Progress;var UploaderID=JProgress.uploader;if(!this.ProgressBars[UploaderID])return;if(this.ProgressBars[UploaderID].Complete==true)return;if(JProgress.apc=='no'){return;}
var Progress=JProgress.progress;this.ProgressBars[UploaderID].Progress=Progress;this.ProgressBars[UploaderID].Total=JProgress.total;var FileListing=jQuery('#'+UploaderID+'_listing');if(JProgress.total!=null&&JProgress.total!=-1){jQuery(FileListing.find('.FileSize')).html(JProgress.format_total);}
if(!this.ProgressBars[UploaderID].Complete){var UploadProgress=FileListing.find('div.UploadProgress');var ProgressForeground=FileListing.find('div.UploadProgress div.Foreground');var ProgressBackground=FileListing.find('div.UploadProgress div.Background');ProgressForeground.html('<strong>Uploading:</strong> '+Math.ceil(Progress)+'%');ProgressBackground.css('width',((Progress*jQuery(UploadProgress).width())/100)+'px');}}
if(ExecuteApcLookup){Progress=parseInt(Progress);if((!this.ProgressBars[UploaderID].Complete&&Progress<100)||(this.ProgressBars[UploaderID].Complete&&Progress<=0)){this.TID=this.ProgressBars[UploaderID].TimerID=setTimeout(jQuery.proxy(function(){this.Progress(UploaderID);},this),100);}}
return;}
if(ExecuteApcLookup){var Action=['post','checkupload',ApcKey,this.ProgressBars[UploaderID].Progress];var FinalURL=gdn.url(Action.join('/')+'?randval='+Math.random());jQuery.ajax({url:FinalURL,type:'GET',async:true,success:jQuery.proxy(this.Progress,this)});}}
Gdn_MultiFileUpload.prototype.UploadComplete=function(IFrameName,TargetUploaderID){if(this.IFrames[IFrameName].ready!='yes'){this.IFrames[IFrameName].ready='yes';return;}
var IFR=document.getElementById(IFrameName);var Response=IFR.contentWindow.document.body.innerHTML;var UploadResultStatus='fail';var FailReason='An unknown error occured.';var JResponse=jQuery.parseJSON(Response);if(JResponse&&JResponse.MediaResponse){if(JResponse.MediaResponse.Status=='success'){UploadResultStatus='success';if(!this.ProgressBars[TargetUploaderID])return;var Filename=JResponse.MediaResponse.Filename;var StoredFilename=this.ProgressBars[TargetUploaderID].Filename;if(StoredFilename!=Filename)return;var MediaID=JResponse.MediaResponse.MediaID;this.ProgressBars[TargetUploaderID].Complete=true;this.MyFiles[MediaID]=Filename;this.RemoveUploader(TargetUploaderID);var EnableMe=this.CreateElement('input',{'type':'hidden','name':'AttachedUploads[]','value':MediaID});var TrackAll=this.CreateElement('input',{'type':'hidden','name':'AllUploads[]','value':MediaID});var FileListing=jQuery('#'+[TargetUploaderID,'listing'].join('_'));if(JResponse.MediaResponse.Filesize!=null){jQuery(FileListing.find('.FileSize')).html(JResponse.MediaResponse.FormatFilesize);}
jQuery(FileListing.find('.FileOptions')).append(EnableMe);if(this.isIE)
EnableMe.checked='true';jQuery(FileListing.find('.FileName')).text(Filename);jQuery(FileListing.find('.FileOptions')).append(TrackAll);jQuery(FileListing.find('div.UploadProgress')).remove();var img=document.createElement('img'),img2=document.createElement('img');img.src=img2.src=JResponse.MediaResponse.PreviewImageLocation;jQuery(FileListing.find('div.FilePreview')).append(img);jQuery(FileListing.find('div.FileHover')).prepend(img2);if(JResponse.MediaResponse.FinalImageLocation!=''){var ImageAnchor=jQuery(FileListing.find('a.InsertImage'));ImageAnchor.attr('href',JResponse.MediaResponse.FinalImageLocation);ImageAnchor.show();ImageAnchor.live('click',function(){var insertimg='<img src="'+ImageAnchor.attr('href')+'" />';var wysiwyg=jQuery(FileListing.parents('form').find('iframe'));if(wysiwyg){var editorbox=wysiwyg.contents().find('body');editorbox.html(function(index,oldhtml){return oldhtml+insertimg});}
else{var txtbox=jQuery(FileListing.parents('form').find('textarea'));txtbox.val(txtbox.val()+insertimg);}
return false;});}}else{FailReason='<pre>'+JResponse.MediaResponse.StrError+'</pre>';this.ProgressBars[TargetUploaderID].Complete=true;}}
if(UploadResultStatus=='fail'){clearTimeout(this.ProgressBars[TargetUploaderID].TimerID);this.RemoveUploader(TargetUploaderID);var FileListing=jQuery('#'+[TargetUploaderID,'listing'].join('_'));FileListing.html("File upload failed. Reason: "+FailReason);FileListing.css({'background-color':'#ffbfbf','color':'#a70000','padding-left':'20px','background-position':'8px center','cursor':'pointer'});FileListing.click(function(){FileListing.remove();});delete this.ProgressBars[TargetUploaderID];}}
Gdn_MultiFileUpload.prototype.RemoveUploader=function(UploaderID){var TargetFrame=jQuery('#'+this.ProgressBars[UploaderID].Target);var TargetForm=jQuery('#'+this.ProgressBars[UploaderID].Target+'_form');TargetFrame.parent().remove();TargetForm.remove();}
Gdn_MultiFileUpload.prototype.Stop=function(){clearTimeout(this.TID);}}
var GdnUploaders=null;jQuery(document).ready(function($){GdnUploaders=new Gdn_Uploaders();GdnUploaders.Prepare()
$('.Attachment .InsertImage').live('click',function(){var txtbox=jQuery(this).closest('form').find('textarea');txtbox.val(txtbox.val()+'<img src="'+jQuery(this).attr('href')+'" />');return false;});$('.Comment a.EditComment').click(function(){$('.Comment > .Attachments',$(this).closest('.Item')).remove();});});